<div class="show-list-page">
  <%# â”€â”€ HEADER â”€â”€ %>
  <div class="show-list-header px-4 pt-4 pb-3">
    <%= link_to lists_path, class: "back-link" do %>
      <i class="fa-solid fa-chevron-left me-1"></i>Back
    <% end %>
    <h1 class="show-list-title mt-3">ðŸ›’ <%= @list.name %></h1>
  </div>
  <%# â”€â”€ ADD ITEM FORM â”€â”€ %>
  <div class="px-4 mb-3">
    <%= form_with url: attach_list_items_path(@list),
                  scope: :item,
                  method: :post,
                  class: "add-item-form" do %>
      <%= label_tag :query, "Add an Item", class: "visually-hidden" %>
      <%= text_field_tag :query,
          params[:query],
          class: "add-item-input",
          placeholder: "Add an itemâ€¦" %>
      <%= submit_tag "+",
          name: "",
          class: "add-item-btn" %>
    <% end %>
  </div>
  <%# â”€â”€ ITEMS â”€â”€ %>
  <div class="lists-body px-4 pb-5">
    <% if @items.any? %>
      <div class="accordion" id="itemsAccordion">
        <% @items.each do |item| %>
          <div class="list-card flex-column align-items-stretch p-0 overflow-hidden">
            <%# Row %>
            <div class="show-item-row">
              <%# Clickable area toggles accordion %>
              <button class="show-item-btn collapsed"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapse<%= item.id %>"
                      aria-expanded="false"
                      aria-controls="collapse<%= item.id %>">
                <%# Left: name %>
                <div class="item-col-left">
                  <span class="item-label"><%= item.name.capitalize %></span>
                </div>
                <%# Centre: quantity %>
                <div class="item-col-mid">
                  <span class="item-label">Ã— <%= item.quantity %></span>
                </div>
                <%# Price %>
                <div class="item-col-price">
                  <span class="item-price-label">
                    <%= item.display_total_price %>
                  </span>
                  <i class="fa-solid fa-chevron-down show-chevron ms-2"></i>
                </div>
              </button>
              <%# Delete â€” outside the button so it fires correctly %>
              <%= button_to list_item_path(@list, item),
                  method: :delete,
                  class: "btn-delete item-delete",
                  form: { data: { turbo_confirm: "Remove this item?" } } do %>
                <i class="fa-solid fa-trash"></i>
              <% end %>
            </div>
            <%# Accordion body â€” product price cards %>
            <div id="collapse<%= item.id %>"
                class="accordion-collapse collapse"
                data-bs-parent="#itemsAccordion">
              <div class="show-accordion-body">
                <% grouped_prices = item.prices_grouped_by_store %>
                <% if grouped_prices.any? %>
                  <% lowest_price_val = grouped_prices.values.flatten.map(&:price_with_tax).min %>
                  <div class="store-scroll">
                    <% grouped_prices.each do |store, prices| %>
                      <div class="store-group-box">
                        <div class="store-group-header">
                          <strong><%= store.name %></strong>
                        </div>
                        <div class="product-scroll">
                          <% prices.each do |price| %>
                            <% is_best_price = price.price_with_tax == lowest_price_val %>
                            <div class="product-price-card <%= 'selected-border' if item.price_id == price.id %> <%= 'best-price-card' if is_best_price %>" >
                              <% if is_best_price %>
                                <span class="best-price-label">Best Price</span>
                              <% end %>
                              <div class="product-image-placeholder">ðŸ¥¬</div>
                              <p class="product-desc"><%= price.product.description %></p>
                              <p class="product-price-tag">Â¥<%= price.price_with_tax %></p>
                              <%= button_to "Select", list_item_path(@list, item, item: { price_id: price.id }),
                                    method: :patch,
                                    class: "btn-select-price" %>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <p class="no-products-msg">No products found.</p>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
      <div class="list-total-card mt-4 p-3 d-flex justify-content-between align-items-center">
        <span class="total-label">Total</span>
        <% list_total = @items.select(&:price).sum { |item| item.price.price_with_tax * item.quantity } %>
        <span class="total-price">Â¥<%= list_total %></span>
      </div>
    <% else %>
      <div class="lists-empty text-center py-5">
        <div class="empty-icon">ðŸ¥¡</div>
        <p class="mt-3 text-muted">No items yet.<br>
          Add your first one above!</p>
      </div>
    <% end %>
  </div>
  <%# â”€â”€ MAP â”€â”€ %>
  <% if @stores.present? && @items.present? %>
    <div class="px-4 mb-3">
      <div id="map"
           style="height: 300px; border-radius: 12px;"
           data-controller="map"
           data-map-token-value="<%= ENV['MAPBOX_TOKEN'] %>"
           data-map-stores-value="<%= @stores.each { |s| { name: s.name, address: s.address, latitude: s.latitude, longitude: s.longitude } }.to_json %>">
      </div>
    </div>
  <% else %>
    <div class="px-4 mb-3">
      <div id="map"
           style="height: 300px; border-radius: 12px;"
           data-controller="map"
           data-map-token-value="<%= ENV['MAPBOX_TOKEN'] %>">
      </div>
    </div>
  <% end %>
</div>
